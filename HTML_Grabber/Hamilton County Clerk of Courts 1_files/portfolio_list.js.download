$(function(){
    $(".datepicker").datepicker({
        yearRange: "-90:-16",
        showButtonPanel: true,
        changeMonth: true,
        changeYear: true,
        autoclose: true
    });
    loadResultsTable();
});

// all intial search criteria validations
function checkcc ( form_id )
{
    form = document.getElementById(form_id);
    if(validator.isEmpty(form.casenumber.value) || !validator.isLength(form.casenumber.value, {min:6,max:50})) {
        alert("Invalid Case Number: Must be at least 6 digits");
        return false;
    }
    addCaseToDB (form_id);
}

function loadResultsTable() {
    // delete rows from table
    var tableHeaderRowCount = 1;
    var cl_table = document.getElementById('case_list_table');
    var rowCount = cl_table.rows.length;
    for (var i = tableHeaderRowCount; i < rowCount; i++) {
        cl_table.deleteRow(tableHeaderRowCount);
    }

    // suppress user notification
    document.getElementById('message').style.display = "none";

    // call portfolio list
    $.ajax ({
        url:  'db_script/portfolio_manage.php',
        type: 'POST',
        // post the form variables
        data: ( {"action": "list" } ),
        dataType: "json",                                  // return datatype. do php json_encode before replying back
        success: function(response) {
            //console.log(response);
            // alert(JSON.stringify(response));

            if(response.status > 0) {
                cl_table.style.display = "block";
                // alert(response.message);
                for (var key in response) {
                    // console.log(key + '=' + response[key]);
                    val = response[key];
                    if(typeof val == 'object') {
                        // console.log(val)
                        // console.log(val.CASE_ID);
                        // console.log(val.CASENUMBER);
                        // console.log(val.CASE_NUM_MINOR);
                        // console.log(val.CASE_TITLE_PLAINTIFF);
                        // console.log(val.CASE_TITLE_DEFENDANT);
                        // console.log(val.DOCKET_URL);

                        var rowCount = cl_table.rows.length;

                        insertCaseListEntry(cl_table, val, rowCount);
                    }
                }
                cl_table.style.tableLayout    = "fixed";
                cl_table.style.borderCollapse = "collapse";
                cl_table.style.width          = "100%";
                cl_table.style.marginLeft     = "2px";
                cl_table.style.marginRight    = "2px";

            } else {
                // no data found hide the table and display a message
                document.getElementById('case_list_table').style.display = "none";
                document.getElementById('message').style.display = "block";
                document.getElementById('message').innerHTML = "You do not have any cases in your portfolio";
            }


        }, // end success function
        error: function (jqXHR, exception) {
            console.log(jqXHR);
            getErrorMessage(jqXHR, exception);
        }
    });

}

function delCaseFromDB(cell) {
    var caseid = cell.name;
    //alert(caseid);
    //return false;

    $.ajax ({
        url:  'db_script/portfolio_manage.php',
        // contentType: 'application/json; charset=UTF-8', // doesnt work well with serialize()
        type: 'POST',
        // post the form variables
        data: ( {"action": "delete", "caseid": caseid } ),
        dataType: "json",                                  // return datatype. do php json_encode before replying back
        success: function(response) {
            // console.log(response);
            //alert(JSON.stringify(response));
            if ( response.length == 0 ) {
                alert("No Results Found. Try Again?");
                window.location.reload()
            }

            // document.getElementById("ajx").innerHTML = " Status = " + response.status + ", Message = " + response.message;
            if(response.status >= 0) {
                // alert(response.message);
                // loadResultsTable();
                // Just remove the one row that the user deleted, rowid and cell name are the same
                var delRow = document.getElementById(caseid);
                delRow.parentNode.removeChild(delRow);
            }

        }, // end success function
        error: function (jqXHR, exception) {
            console.log(jqXHR);
            getErrorMessage(jqXHR, exception);
        }
    });
}

function addCaseToDB(form_id) {
    $.ajax ({
        url:  'db_script/portfolio_manage.php',
        // contentType: 'application/json; charset=UTF-8', // doesnt work well with serialize()
        type: 'POST',
        // post the form variables
        data: $(document.getElementById(form_id)).serialize() ,
        dataType: "json",                                  // return datatype. do php json_encode before replying back
        success: function(response) {
            // console.log(response);
            //alert(JSON.stringify(response));
            if ( response.length == 0 ) {
                alert("No Results Found. Try Again?");
                window.location.reload()
            }

            // document.getElementById("ajx").innerHTML = " Status = " + response.status + ", Message = " + response.message;
            if(response.status >= 0) {
                alert(response.message);
                // loadResultsTable(); instead of rebuilding, update the table addind the one case
                var cl_table = document.getElementById('case_list_table');
                // we may call ADD from other locations than portfolio list, only update the table if it exists in the DOM
                if(cl_table) {
                    for (var key in response) {
                        val = response[key];
                        if(typeof val == 'object') {
                            insertCaseListEntry(cl_table, val, 1); // insert at row position 1
                        }
                    }
                }
            }

        }, // end success function
        error: function (jqXHR, exception) {
            console.log(jqXHR);
            getErrorMessage(jqXHR, exception);
        }
    });
}


// This function is used to get error message for all ajax calls
function getErrorMessage(jqXHR, exception) {
    var msg = '';
    if (jqXHR.status === 0) {
        msg = 'Not connect.\n Verify Network.';
    } else if (jqXHR.status == 404) {
        msg = 'Requested page not found. [404]';
    } else if (jqXHR.status == 500) {
        msg = 'Internal Server Error [500].';
    } else if (exception === 'parsererror') {
        msg = 'Requested JSON parse failed.';
    } else if (exception === 'timeout') {
        msg = 'Time out error.';
    } else if (exception === 'abort') {
        msg = 'Ajax request aborted.';
    } else {
        msg = 'Uncaught Error.\n' + jqXHR.responseText;
    }
    $('#ajx').html(msg);
}


// inserts a row in the table at the specified location = rownum
function insertCaseListEntry(my_table, val, rownum) {

    // insert row
    var my_row  = my_table.insertRow(rownum);
    // set row id to the case id, needed for delete action
    my_row.id   = val.CASE_ID;

    // Cell 0: Case Number
    var cell0 = my_row.insertCell(0);
    cell0.style.whiteSpace = "nowrap";
    cell0.innerHTML = val.CASENUMBER;

    // Cell 1: Date
    var cell1 = my_row.insertCell(1);
    cell1.style.whiteSpace = "nowrap";
    cell1.innerHTML = val.CREATE_DATE_TIME;

    // Cell 2: Associated Case
    var cell2 = my_row.insertCell(2);
    cell2.style.whiteSpace = "nowrap";
    cell2.innerHTML = val.CASE_NUM_MINOR;

    // Cell 3: Caption
    var cell3 = my_row.insertCell(3);
    cell3.style.textAlign  = "center";
    if((val.CASE_TITLE_PLAINTIFF.length > 0) || (val.CASE_TITLE_DEFENDANT.length  > 0)) {
        cell3.innerHTML = val.CASE_TITLE_PLAINTIFF + '<br/><b> vs. </b><br/>' + val.CASE_TITLE_DEFENDANT;
    } else {
        cell3.innerHTML = '&nbsp;';
    }

    // Cell 4: Link to case summary
    var cell4 = my_row.insertCell(4);
    cell4.style.alignContent = "center";
    cell4.innerHTML = val.DOCKET_URL;

    // Cell 5: Link to case summary sec docs
    var cell5 = my_row.insertCell(5);
    cell5.style.alignContent = "center";
    cell5.innerHTML = val.DOCS_URL;

    // Cell 6: Delete
    var cell6 = my_row.insertCell(6);
    cell6.style.alignContent = "center";
    cell6.innerHTML = "<input type='image' name='" + val.CASE_ID + "' onClick='{delCaseFromDB(this)}; return false' src='/data/ico/24x24/places/user-trash.ico' alt='Delete' />";
}


